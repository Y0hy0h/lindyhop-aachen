language: node_js
node_js:
  - "lts/*"

# Prevent automatically created tags from retriggering the build.
# See https://docs.travis-ci.com/user/deployment/releases/#when-tag-is-not-set-at-deployment-time
branches:
  except:
   - /^untagged/

services:
  - docker

jobs:
  include:
    - stage: test
      script: yarn test
      
    - stage: build
      script:
        - docker build -t lindy .
      before_deploy:
        # Copy built files out of container
        - docker create --name lindy lindy
        - "docker cp lindy:/lindyhop-aachen ./dist"
        # Prepare for upload
        - zip dist.zip dist/**/*
      deploy:
        provider: releases
        skip_cleanup: true
        api_key: $GITHUB_PERSONAL_ACCESS_TOKEN
        file: dist.zip
        on:
          branch:
            - deploy-docker
